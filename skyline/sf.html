<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>San Francisco, California</title>
    <style>
        body {
            margin: 0;
            background-color: rgba(46, 38, 116, 0.835);
            background: transparent;
            /* overflow: hidden; */
        }

        canvas {
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 1);
            margin: 0;
        }

        #tint {
            background: transparent;
            background-color: rgba(182, 26, 26, 1)
        }
    </style>
</head>

<body>
    <canvas id="frame" width="1280" height="720"></canvas>
    <canvas id="canvas" width="3617" height="2025"></canvas>
    <canvas id="tint" width="3617" height="568"></canvas>
    <input type="button" value="save" id="savecanvas">
</body>
<script type="module">
    import { GUI } from '../js/dat.gui.module.js';
    import { Vector } from '../js/mr.vector.js';

    document.getElementById("savecanvas").addEventListener("click", savecanvas);

        function getRandomIntInclusive(min, max) {
            min = Math.ceil(min);
            max = Math.floor(max);
            return Math.floor(Math.random() * (max - min + 1)) + min; //The maximum is inclusive and the minimum is inclusive 
        }

    let location = new Vector(500, 700);
    let velocity = new Vector(1, 0);

    let frameLocation = new Vector(975, 800);
    let frameVelocity = new Vector(1, 0);

    let redRangeStart = Math.floor(Math.random() * 255)
    let blueRangeStart = Math.floor(Math.random() * 255)
    let greenRangeStart = Math.floor(Math.random() * 255)
    let redRangeEnd = Math.floor(Math.random() * 255)
    let blueRangeEnd = Math.floor(Math.random() * 255)
    let greenRangeEnd = Math.floor(Math.random() * 255)

    let gredRangeStart = Math.floor(Math.random() * 255)
    let gblueRangeStart = Math.floor(Math.random() * 255)
    let ggreenRangeStart = Math.floor(Math.random() * 255)
    let gredRangeEnd = Math.floor(Math.random() * 255)
    let gblueRangeEnd = Math.floor(Math.random() * 255)
    let ggreenRangeEnd = Math.floor(Math.random() * 255)


    let x0 = Math.floor(Math.random() * canvas.width)
    let y0 = Math.floor(Math.random() * canvas.height)
    let r0 = Math.floor(Math.random() * canvas.height)
    let x1 = Math.floor(Math.random() * canvas.width)
    let y1 = Math.floor(Math.random() * canvas.height)
    let r1 = Math.floor(Math.random() * canvas.height)

    let img = new Image();
    let image = new Image();

    let date = Date.now();

    function init() {
        // img.src = 'sheets/path1459.png';
        img.src = 'sheets/1x/sf.png'
        window.requestAnimationFrame(draw);
        let ctx = document.getElementById('canvas').getContext('2d');
        let tint_ctx = document.getElementById('tint').getContext('2d');
        let tint_canvas = document.getElementById('tint')
        var gradient = ctx.createRadialGradient(x0, y0, r0, x1, y1, r1);
        gradient.addColorStop(0, `rgba(${prg}, ${pgg}, ${pbg}, ${pag})`);
        gradient.addColorStop(.5, `rgba(${pr2g}, ${pg2g}, ${pb2g}, ${pa2g})`);
        gradient.addColorStop(1, `rgba(${pr3g}, ${pg3g}, ${pb3g}, ${pa3g})`);
        ctx.fillStyle = gradient;

        ctx.fillRect(0, 0, canvas.width, canvas.height);


        image.id = "pic";
        img.addEventListener('load', function () {

            // ctx.drawImage(img, 0, 1391, 3617, 568, 0, 923, 3617, 568)

            // tint_ctx.fillStyle = 'orange'
            tint_ctx.fillStyle = `rgba(${getRandomIntInclusive(0,255)}, ${getRandomIntInclusive(0, 255)}, ${getRandomIntInclusive(0, 255)}, ${getRandomIntInclusive(0, 255)})`
            tint_ctx.drawImage(img, 0, 0, 3617, 568, 0, 0, 3617, 568)
            tint_ctx.globalCompositeOperation = 'source-atop'
            tint_ctx.fillRect(0, 0, 3617, 568)

            image.src = tint_canvas.toDataURL();
            image.addEventListener('load', function () {
                ctx.drawImage(image, 0, 923)
            }, false);

        }, false);



    }

    function randn_bm(min, max, skew) {
        let u = 0, v = 0;
        while (u === 0) u = Math.random(); //Converting [0,1) to (0,1)
        while (v === 0) v = Math.random();
        let num = Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);

        num = num / 10.0 + 0.5; // Translate to 0 -> 1
        if (num > 1 || num < 0) num = randn_bm(min, max, skew); // resample between 0 and 1 if out of range
        num = Math.pow(num, skew); // Skew
        num *= max - min; // Stretch to fill range
        num += min; // offset to min
        return num;
    }


    function savecanvas() {
        console.log("Save")
        var canvas = document.getElementById('canvas');

        canvas.toBlob(function (blob) {
            var newImg = document.createElement('img'),
                url = URL.createObjectURL(blob);

            newImg.onload = function () {
                // no longer need to read the blob so it's revoked
                URL.revokeObjectURL(url);
            };

            newImg.src = url;
            document.body.appendChild(newImg);
        });
    }
    let prg = randn_bm(gredRangeStart, gredRangeEnd, 1)
    let pgg = randn_bm(gblueRangeStart, gblueRangeEnd, 1)
    let pbg = randn_bm(ggreenRangeStart, ggreenRangeEnd, 1)
    let pag = randn_bm(200, 255, 1)

    let pr2g = randn_bm(gredRangeStart, gredRangeEnd, 1)
    let pg2g = randn_bm(gblueRangeStart, gblueRangeEnd, 1)
    let pb2g = randn_bm(ggreenRangeStart, ggreenRangeEnd, 1)
    let pa2g = randn_bm(200, 255, 1)

    let pr3g = randn_bm(gredRangeStart, gredRangeEnd, 1)
    let pg3g = randn_bm(gblueRangeStart, gblueRangeEnd, 1)
    let pb3g = randn_bm(ggreenRangeStart, ggreenRangeEnd, 1)
    let pa3g = randn_bm(200, 255, 1)



    function draw() {
        let ctx = document.getElementById('canvas').getContext('2d');
        let tint_ctx = document.getElementById('tint').getContext('2d');

        let canvas2 = document.createElement("canvas");
        canvas2.width = 3617;
        canvas2.height = 568;
        let ctx2 = canvas2.getContext("2d");

        ctx.save();
        // clear background. Get the paint on effect by commenting it out
        // ctx.clearRect(0, 0, canvas.width, canvas.height);
        // for (let i = 0; i < 50; i++) {
        //     let cx = Math.floor(Math.random() * canvas.width)
        //     let cy = Math.floor(Math.random() * canvas.height)
        //     let pwidth = Math.floor(Math.random() * 25)
        //     let pheight = Math.floor(Math.random() * 25)
        //     let pr = Math.floor(Math.random() * 255)
        //     let pg = Math.floor(Math.random() * 255)
        //     let pb = Math.floor(Math.random() * 255)
        //     let pa = Math.floor(Math.random() * 255)
        //     let fblur = Math.floor(Math.random() * 1)
        //     // ctx.fillStyle = `rgba(${pr}, ${pg}, ${pb}, ${pa})`;
        //     let gradient = ctx.createRadialGradient(cx, cy, 1, cx + 5, cy + 5, 1.5);
        //     gradient.addColorStop(0, `rgba(${pr}, ${pg}, ${pb}, ${pa})`);
        //     gradient.addColorStop(.5, `rgba(${pb}, ${pg}, ${pr}, ${pg})`);
        //     gradient.addColorStop(1, `rgba(${pg}, ${pb}, ${pa}, ${pb})`);
        //     ctx.fillStyle = gradient;

        //     // ctx.filter = `blur(${fblur}px)`
        //     // ctx.fillRect(cx, cy, pwidth, pheight);
        // }

        if ((location.x > canvas.width) || (location.x < 0)) {
            velocity.x = velocity.x * -1;
        }
        if ((location.y > canvas.height) || (location.y < 0)) {
            velocity.y = velocity.y * -1;
        }

        if ((frameLocation.x > canvas.width * .75) || (frameLocation.x < 0)) {
            frameVelocity.x = frameVelocity.x * -1;
        }
        if ((frameLocation.y > canvas.height) || (frameLocation.y < 0)) {
            frameLocation.y = frameLocation.y * -1;
        }

        location.add(velocity);
        frameLocation.add(frameVelocity)

        //3000x2024
        //  top
        // ctx.drawImage(img, 0, 0, 2992, 1088, 0, 0, 2992, 1088)

        // black cloud
        // ctx.drawImage(img, 6006, 0, 2994, 810, 0, 0, 2994, 810)

        // // bottom
        // ctx.drawImage(img, 0, 1336, 2996, 696, 0, 1336, 2996, 696)

        // // middle
        // ctx.drawImage(img, 6000, 923, 3000, 421, 0, 923, 3000, 421)



        let bridge = { x: 6, y: 1085, width: 1784, height: 312 }
        ctx.drawImage(img, 3617, 0, bridge.width, bridge.height, bridge.x, bridge.y, bridge.width, bridge.height)

        ctx.drawImage(img, 0, 1391, 3617, 568, 0, 923, 3617, 568)
        // ctx.drawImage(image, 0, 1391, 3617, 568, 0, 923, 3617, 568)
        ctx.drawImage(image, 0, 923)


        // slice of bridge and city
        // ctx.colorMask(true, true, false, true);
        // ctx.filter = 'hue-rotate(45deg)'
        // myCanvas.offscreenCanvas.width = 3617;
        // myCanvas.offscreenCanvas.height = 568;
        // tint_ctx.globalAlpha = 0.0;
        // tint_ctx.fillStyle = 'rgba(255, 0, 0, 0)'
        // tint_ctx.fillRect(0, 0, 3617, 568)
        // tint_ctx.clearRect(0, 0, 3617, 568)

        // tint_ctx.draw
        // tint_ctx.globalCompositeOperation = "destination-atop"

        // ctx2.globalCompositeOperation = "source-over"

        // tint_ctx.drawImage(img, 0, 0, 3617, 568, 0, 0, 3617, 568)
        // let imgData = tint_ctx.getImageData(0, 0, 3617, 568);

        // let imgDataDest = ctx.getImageData(0, 932, 3617, 568);

        // ctx2.drawImage(img, 0, 0, 3617, 568, 0, 0, 3617, 568)
        // let c2imgData = ctx2.getImageData(0, 0, 3617, 568);

        // ctx.drawImage(img, 3, 0, 3617, 568, 0, 923, 3617, 568)

        // var i;
        // for (i = 0; i < imgData.data.length; i += 4) {
        //     if (imgData.data[i+3] > 0){
        //         // imgData.data[i] = imgDataDest.data[i];
        //         // imgData.data[i + 1] = imgDataDest.data[i + 1];
        //         // imgData.data[i + 2] = imgDataDest.data[i + 2];
        //         // imgData.data[i] = imgData.data[i];
        //         // imgData.data[i + 1] = imgData.data[i + 1];
        //         // imgData.data[i + 2] = imgData.data[i + 2];
        //     }
        //     else {
        //         // imgData.data[i] = imgDataDest.data[i];
        //         // imgData.data[i + 1] = imgDataDest.data[i + 1];
        //         // imgData.data[i + 2] = imgDataDest.data[i + 2];
        //     }

        //     //imgData.data[i + 3] = imgData.data[i + 3];
        // }
        // ctx.globalCompositeOperation = "source-over"

        // ctx.putImageData(imgData, 0, 932); 


        // ctx.putImageData(imgData, 3, 0, 3617, 568, 0, 923, 3617, 568); 

        //ctx.putImageData(imgData, 3, 923); 
        // ctx.putImageData(c2imgData, 3, 923); 
        // ctx.drawImage(c2imgData, 3, 932)

        // var imgData = ctx.getImageData(0, 923, 1617, 568);

        // var i;
        // for (i = 0; i < imgData.data.length; i += 4) {
        //     imgData.data[i] = 255 - imgData.data[i];
        //     imgData.data[i + 1] = 255 - imgData.data[i + 1];
        //     imgData.data[i + 2] = 255 - imgData.data[i + 2];
        //     imgData.data[i + 3] = 255;
        // }

        // ctx.putImageData(imgData, 3, 0, 0, 923, 3617, 568); 

        ctx.fillStyle = 'black'
        ctx.font = '12px serif';
        ctx.strokeText('Dreadknot:' + date, 850, 1400)

        // ctx.fillStyle = 'white'
        // ctx.font = '90px serif';
        // ctx.fillText('Dreadknot:' + date, 850, 1000)

        //  water
        // ctx.drawImage(img, 0, 0, 3008, 768, 0, 0, 1280, 360)
        // cloud
        // ctx.drawImage(img, 6230, 578, 193, 33, location.x, location.y, 193, 33)
        // ctx.drawImage(img, 4118, 576, 164, 60, 642, 542, 164, 60)
        // let pr = randn_bm(0, 25, 1)
        // let pg = randn_bm(0, 50, 1)
        // let pb = randn_bm(0, 255, 1)
        // let pa = randn_bm(200, 255, 1)

        // let pr2 = randn_bm(0, 25, 1)
        // let pg2 = randn_bm(0, 50, 1)
        // let pb2 = randn_bm(0, 255, 1)
        // let pa2 = randn_bm(200, 255, 1)

        // let pr3 = randn_bm(0, 25, 1)
        // let pg3 = randn_bm(0, 50, 1)
        // let pb3 = randn_bm(0, 255, 1)
        // let pa3 = randn_bm(200, 255, 1)



        for (let i = 0; i < 50; i++) {
            let cx = Math.floor(randn_bm(frameLocation.x, frameLocation.x + 1280, 1))
            let cy = Math.floor(randn_bm(frameLocation.y - 360, frameLocation.y + 720, 1))
            let pwidth = Math.floor(Math.random() * 25)
            let pheight = Math.floor(Math.random() * 25)



            let pr = randn_bm(redRangeStart, redRangeEnd, 1)
            let pg = randn_bm(blueRangeStart, blueRangeEnd, 1)
            let pb = randn_bm(greenRangeStart, greenRangeEnd, 1)
            let pa = randn_bm(200, 255, 1)

            let pr2 = randn_bm(redRangeStart, redRangeEnd, 1)
            let pg2 = randn_bm(blueRangeStart, blueRangeEnd, 1)
            let pb2 = randn_bm(greenRangeStart, greenRangeEnd, 1)
            let pa2 = randn_bm(200, 255, 1)

            let pr3 = randn_bm(redRangeStart, redRangeEnd, 1)
            let pg3 = randn_bm(blueRangeStart, blueRangeEnd, 1)
            let pb3 = randn_bm(greenRangeStart, greenRangeEnd, 1)
            let pa3 = randn_bm(200, 255, 1)

            let fblur = Math.floor(Math.random() * 1)
            let brush_size = Math.random() * (1.5 - .5) + .5
            let brush_distance = Math.random() * (5 - 1) + 1
            // ctx.fillStyle = `rgba(${pr}, ${pg}, ${pb}, ${pa})`;
            let gradient = ctx.createRadialGradient(cx, cy, brush_size, cx + brush_distance, cy + brush_distance, brush_size);
            gradient.addColorStop(0, `rgba(${pr}, ${pg}, ${pb}, ${pa})`);
            gradient.addColorStop(.5, `rgba(${pr2}, ${pg2}, ${pb2}, ${pa2})`);
            gradient.addColorStop(1, `rgba(${pr3}, ${pg3}, ${pb3}, ${pa3})`);
            ctx.fillStyle = gradient;

            // ctx.filter = `blur(${fblur}px)`
            ctx.fillRect(cx, cy, pwidth, pheight);
        }


        ctx.restore();

        let frame_ctx = document.getElementById('frame').getContext('2d');
        frame_ctx.putImageData(ctx.getImageData(frameLocation.x, frameLocation.y, 1280, 720), 0, 0);
        // frame_ctx.drawImage(ctx.i, 0, 0)

        window.requestAnimationFrame(draw);
    }

    init();

</script>

</html>